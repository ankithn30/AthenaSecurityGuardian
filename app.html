<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge AI Camera Bridge - Offline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            height: 100vh;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-panel h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.6rem;
        }

        .network-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .network-info h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .ip-address {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            text-align: center;
            margin: 10px 0;
        }

        .qr-section {
            text-align: center;
            margin-bottom: 25px;
        }

        #qrcode {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .qr-instructions {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }

        .qr-instructions h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .qr-instructions ol {
            color: #856404;
            padding-left: 20px;
        }

        .qr-instructions li {
            margin-bottom: 5px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status.waiting {
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #bbdefb;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.streaming {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .controls {
            display: grid;
            gap: 12px;
            margin-bottom: 25px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa726 0%, #ffb74d 100%);
            color: white;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .video-panel h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 450px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }

        .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
        }

        .video-overlay i {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .cv-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stats {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .stats h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .detection-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }

        .phone-view {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .phone-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
        }

        .phone-controls button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        #phoneVideo {
            width: 100%;
            height: 70vh;
            object-fit: cover;
            border-radius: 15px;
            border: 3px solid #667eea;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .panel {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Phone view styles */
        body.phone-mode {
            background: #000;
            padding: 0;
        }

        body.phone-mode .container {
            display: none;
        }

        body.phone-mode .phone-view {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #000;
            color: white;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Desktop View -->
    <div class="container">
        <div class="panel control-panel">
            <h2>üè† Local Edge AI Bridge</h2>
            
            <div class="network-info">
                <h3>üì° Network Information</h3>
                <div>Local IP: <div class="ip-address" id="localIP">Detecting...</div></div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    ‚ö†Ô∏è Ensure phone and PC are on the same WiFi network
                </div>
            </div>

            <div class="qr-section">
                <div id="qrcode"></div>
                <div class="qr-instructions">
                    <h4>üì± How to Connect:</h4>
                    <ol>
                        <li>Connect your phone to the same WiFi</li>
                        <li>Open camera app or QR scanner</li>
                        <li>Scan the QR code above</li>
                        <li>Allow camera and microphone access</li>
                        <li>Start streaming!</li>
                    </ol>
                </div>
            </div>

            <div class="status waiting" id="connectionStatus">
                üì± Waiting for phone connection...
            </div>

            <div class="controls">
                <button class="btn-primary" id="refreshQR">üîÑ Refresh QR Code</button>
                <button class="btn-success" id="startServer">üöÄ Start Local Server</button>
                <button class="btn-warning" id="testConnection" disabled>üîó Test Connection</button>
                <button class="btn-danger" id="stopServer" disabled>‚èπÔ∏è Stop Server</button>
            </div>

            <div class="stats">
                <h3>üìä Connection Stats</h3>
                <div class="stat-item">
                    <span>Server Status:</span>
                    <span id="serverStatus">Stopped</span>
                </div>
                <div class="stat-item">
                    <span>Connected Devices:</span>
                    <span id="connectedDevices">0</span>
                </div>
                <div class="stat-item">
                    <span>Data Transfer:</span>
                    <span id="dataTransfer">0 MB</span>
                </div>
                <div class="stat-item">
                    <span>Uptime:</span>
                    <span id="serverUptime">--</span>
                </div>
            </div>
        </div>

        <div class="panel video-panel">
            <h2>üìπ Edge AI Computer Vision</h2>
            
            <div class="video-container">
                <video id="remoteVideo" autoplay muted playsinline></video>
                <div class="video-overlay" id="videoOverlay">
                    <div>üì±</div>
                    <p>Waiting for phone camera...</p>
                    <p style="font-size: 0.9rem; opacity: 0.7;">Scan QR code to start streaming</p>
                </div>
                <div class="detection-overlay" id="detectionOverlay">
                    üéØ Objects Detected: <span id="liveDetectionCount">0</span>
                </div>
            </div>

            <div class="cv-controls">
                <button class="btn-success" id="startDetection" disabled>üéØ Start CV</button>
                <button class="btn-warning" id="captureFrame" disabled>üì∏ Capture</button>
                <button class="btn-primary" id="saveModel" disabled>üíæ Save Model</button>
                <button class="btn-danger" id="stopStreaming" disabled>‚èπÔ∏è Stop Stream</button>
            </div>

            <div class="stats-grid">
                <div class="stats">
                    <h3>üé• Video Stats</h3>
                    <div class="stat-item">
                        <span>Resolution:</span>
                        <span id="videoResolution">--</span>
                    </div>
                    <div class="stat-item">
                        <span>Frame Rate:</span>
                        <span id="frameRate">0 FPS</span>
                    </div>
                    <div class="stat-item">
                        <span>Latency:</span>
                        <span id="streamLatency">-- ms</span>
                    </div>
                    <div class="stat-item">
                        <span>Quality:</span>
                        <span id="streamQuality">--</span>
                    </div>
                </div>

                <div class="stats">
                    <h3>ü§ñ AI Processing</h3>
                    <div class="stat-item">
                        <span>Model Status:</span>
                        <span id="modelStatus">Idle</span>
                    </div>
                    <div class="stat-item">
                        <span>Detections/sec:</span>
                        <span id="detectionsPerSec">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Processing Time:</span>
                        <span id="processingTime">-- ms</span>
                    </div>
                    <div class="stat-item">
                        <span>NPU Usage:</span>
                        <span id="npuUsage">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone View (shown when accessed from phone) -->
    <div class="phone-view" id="phoneView">
        <h2 style="padding: 20px; background: rgba(255,255,255,0.1);">üì± Edge AI Camera</h2>
        <video id="phoneVideo" autoplay playsinline></video>
        <div class="phone-controls">
            <button id="switchCamera">üîÑ</button>
            <button id="toggleFlash">üí°</button>
            <button id="startPhoneStream">üìπ</button>
            <button id="disconnectPhone">‚ùå</button>
        </div>
        <div style="position: fixed; top: 80px; left: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; color: white; font-size: 0.9rem;">
            Status: <span id="phoneStatus">Ready to stream</span>
        </div>
    </div>

    <script>
        class OfflineEdgeAI {
            constructor() {
                this.isPhoneView = this.detectPhoneView();
                this.localIP = null;
                this.serverRunning = false;
                this.connectedDevices = 0;
                this.startTime = null;
                this.currentStream = null;
                this.detectionActive = false;
                this.detectionCount = 0;
                this.dataChannels = new Map();
                
                if (this.isPhoneView) {
                    this.initPhoneView();
                } else {
                    this.initDesktopView();
                }
            }

            detectPhoneView() {
                const urlParams = new URLSearchParams(window.location.search);
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                return urlParams.has('phone') || (isMobile && window.innerWidth < 768);
            }

            async initDesktopView() {
                await this.detectLocalIP();
                this.setupDesktopEventListeners();
                this.generateQRCode();
                this.startStatsUpdater();
            }

            initPhoneView() {
                document.body.classList.add('phone-mode');
                this.setupPhoneEventListeners();
                this.initPhoneCamera();
            }

            async detectLocalIP() {
                try {
                    // Method 1: WebRTC to get local IP
                    const pc = new RTCPeerConnection({iceServers: []});
                    const noop = () => {};
                    
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    pc.onicecandidate = (ice) => {
                        if (ice && ice.candidate && ice.candidate.candidate) {
                            const candidate = ice.candidate.candidate;
                            const match = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                            if (match) {
                                this.localIP = match[1];
                                document.getElementById('localIP').textContent = this.localIP;
                                pc.close();
                            }
                        }
                    };
                } catch (error) {
                    // Fallback: use common local IP patterns
                    this.localIP = '192.168.1.100'; // Placeholder
                    document.getElementById('localIP').textContent = this.localIP + ' (estimated)';
                }
            }

            generateQRCode() {
                const port = 8080; // You'll need to implement the local server
                const phoneUrl = `http://${this.localIP}:${port}?phone=1`;
                
                document.getElementById('qrcode').innerHTML = '';
                
                QRCode.toCanvas(
                    document.getElementById('qrcode'),
                    phoneUrl,
                    {
                        width: 180,
                        margin: 2,
                        color: {
                            dark: '#333333',
                            light: '#FFFFFF'
                        }
                    },
                    (error) => {
                        if (error) {
                            console.error('QR Code generation failed:', error);
                            // Fallback: show URL as text
                            document.getElementById('qrcode').innerHTML = 
                                `<div style="padding: 20px; background: #f8f9fa; border-radius: 10px; word-break: break-all;">${phoneUrl}</div>`;
                        }
                    }
                );
            }

            setupDesktopEventListeners() {
                document.getElementById('refreshQR').addEventListener('click', () => {
                    this.generateQRCode();
                });

                document.getElementById('startServer').addEventListener('click', () => {
                    this.startLocalServer();
                });

                document.getElementById('stopServer').addEventListener('click', () => {
                    this.stopLocalServer();
                });

                document.getElementById('testConnection').addEventListener('click', () => {
                    this.testConnection();
                });

                document.getElementById('startDetection').addEventListener('click', () => {
                    this.toggleDetection();
                });

                document.getElementById('captureFrame').addEventListener('click', () => {
                    this.captureFrame();
                });

                document.getElementById('saveModel').addEventListener('click', () => {
                    this.saveModel();
                });

                document.getElementById('stopStreaming').addEventListener('click', () => {
                    this.stopStreaming();
                });
            }

            setupPhoneEventListeners() {
                document.getElementById('switchCamera').addEventListener('click', () => {
                    this.switchCamera();
                });

                document.getElementById('toggleFlash').addEventListener('click', () => {
                    this.toggleFlash();
                });

                document.getElementById('startPhoneStream').addEventListener('click', () => {
                    this.startPhoneStreaming();
                });

                document.getElementById('disconnectPhone').addEventListener('click', () => {
                    this.disconnectPhone();
                });
            }

            async initPhoneCamera() {
                try {
                    this.currentStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment', // Back camera
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }, 
                        audio: true 
                    });
                    
                    document.getElementById('phoneVideo').srcObject = this.currentStream;
                    document.getElementById('phoneStatus').textContent = 'Camera ready';
                } catch (error) {
                    console.error('Camera access failed:', error);
                    document.getElementById('phoneStatus').textContent = 'Camera access denied';
                }
            }

            startLocalServer() {
                // Simulate server start (in real implementation, you'd start a local HTTP server)
                this.serverRunning = true;
                this.startTime = Date.now();
                this.connectedDevices = 0;
                
                document.getElementById('serverStatus').textContent = 'Running';
                document.getElementById('startServer').disabled = true;
                document.getElementById('stopServer').disabled = false;
                document.getElementById('testConnection').disabled = false;
                
                this.updateStatus('waiting', 'üöÄ Local server started! Scan QR code with phone');
                
                // Simulate phone connection after delay
                setTimeout(() => {
                    this.simulatePhoneConnection();
                }, 5000);
            }

            stopLocalServer() {
                this.serverRunning = false;
                this.connectedDevices = 0;
                this.startTime = null;
                
                document.getElementById('serverStatus').textContent = 'Stopped';
                document.getElementById('startServer').disabled = false;
                document.getElementById('stopServer').disabled = true;
                document.getElementById('testConnection').disabled = true;
                
                this.updateStatus('waiting', 'üì± Server stopped. Click "Start Local Server" to begin');
                this.stopStreaming();
            }

            simulatePhoneConnection() {
                if (!this.serverRunning) return;
                
                this.connectedDevices = 1;
                this.updateStatus('connected', 'üì± Phone connected! Starting camera stream...');
                
                setTimeout(() => {
                    this.startVideoStream();
                }, 2000);
            }

            async startVideoStream() {
                try {
                    // For demo: use local camera as "phone" stream
                    this.currentStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }, 
                        audio: true 
                    });
                    
                    const videoElement = document.getElementById('remoteVideo');
                    videoElement.srcObject = this.currentStream;
                    
                    // Hide overlay and enable controls
                    document.getElementById('videoOverlay').style.display = 'none';
                    this.enableVideoControls();
                    
                    this.updateStatus('streaming', 'üé¨ Live streaming from phone camera');
                    this.updateVideoStats();
                    
                } catch (error) {
                    console.error('Failed to start video stream:', error);
                    this.createSimulatedStream();
                }
            }

            createSimulatedStream() {
                const canvas = document.createElement('canvas');
                canvas.width = 1280;
                canvas.height = 720;
                const ctx = canvas.getContext('2d');
                
                let frameCount = 0;
                const drawFrame = () => {
                    if (!this.serverRunning) return;
                    
                    // Create animated background
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, `hsl(${frameCount % 360}, 70%, 50%)`);
                    gradient.addColorStop(1, `hsl(${(frameCount + 180) % 360}, 70%, 30%)`);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Add simulated objects for detection
                    this.drawSimulatedObjects(ctx, frameCount);
                    
                    // Add frame info
                    ctx.fillStyle = 'white';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üì± Simulated Edge AI Phone Camera', canvas.width/2, 50);
                    ctx.fillText(`Frame: ${frameCount}`, canvas.width/2, canvas.height - 50);
                    
                    frameCount++;
                    if (this.serverRunning) {
                        requestAnimationFrame(drawFrame);
                    }
                };
                
                drawFrame();
                
                const stream = canvas.captureStream(30);
                document.getElementById('remoteVideo').srcObject = stream;
                this.currentStream = stream;
                
                document.getElementById('videoOverlay').style.display = 'none';
                this.enableVideoControls();
                this.updateVideoStats();
            }

            drawSimulatedObjects(ctx, frameCount) {
                // Simulate moving objects for CV detection
                const objects = [
                    { x: 200 + Math.sin(frameCount * 0.02) * 100, y: 200, size: 50, color: '#ff6b6b', type: 'person' },
                    { x: 600 + Math.cos(frameCount * 0.015) * 150, y: 300, size: 40, color: '#4ecdc4', type: 'vehicle' },
                    { x: 1000, y: 150 + Math.sin(frameCount * 0.025) * 80, size: 30, color: '#45b7d1', type: 'object' }
                ];
                
                objects.forEach((obj, index) => {
                    // Draw object
                    ctx.fillStyle = obj.color;
                    ctx.fillRect(obj.x - obj.size/2, obj.y - obj.size/2, obj.size, obj.size);
                    
                    // Draw detection box if CV is active
                    if (this.detectionActive) {
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(obj.x - obj.size/2 - 5, obj.y - obj.size/2 - 5, obj.size + 10, obj.size + 10);
                        
                        // Label
                        ctx.fillStyle = '#00ff00';
                        ctx.font = '16px Arial';
                        ctx.fillText(obj.type, obj.x, obj.y - obj.size/2 - 10);
                    }
                });
                
                if (this.detectionActive) {
                    this.detectionCount = objects.length;
                }
            }

            enableVideoControls() {
                document.getElementById('startDetection').disabled = false;
                document.getElementById('captureFrame').disabled = false;
                document.getElementById('saveModel').disabled = false;
                document.getElementById('stopStreaming').disabled = false;
            }

            toggleDetection() {
                const button = document.getElementById('startDetection');
                const overlay = document.getElementById('detectionOverlay');
                
                if (!this.detectionActive) {
                    this.detectionActive = true;
                    button.textContent = '‚èπÔ∏è Stop CV';
                    button.className = 'btn-danger';
                    overlay.style.display = 'block';
                    
                    document.getElementById('modelStatus').textContent = 'Active';
                    
                    // Simulate real-time detection updates
                    this.detectionInterval = setInterval(() => {
                        if (this.detectionActive) {
                            document.getElementById('liveDetectionCount').textContent = this.detectionCount;
                            document.getElementById('detectionsPerSec').textContent = 
                                Math.floor(Math.random() * 5 + 15);
                            document.getElementById('processingTime').textContent = 
                                Math.floor(Math.random() * 20 + 10) + ' ms';
                            document.getElementById('npuUsage').textContent = 
                                Math.floor(Math.random() * 30 + 40) + '%';
                        }
                    }, 100);
                    
                } else {
                    this.detectionActive = false;
                    button.textContent = 'üéØ Start CV';
                    button.className = 'btn-success';
                    overlay.style.display = 'none';
                    
                    clearInterval(this.detectionInterval);
                    document.getElementById('modelStatus').textContent = 'Idle';
                    document.getElementById('npuUsage').textContent = '0%';
                }
            }

            captureFrame() {
                const video = document.getElementById('remoteVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 1280;
                canvas.height = video.videoHeight || 720;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // Add detection annotations if active
                if (this.detectionActive) {
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#00ff00';
                    
                    // Add timestamp and detection info
                    ctx.fillText(`Detections: ${this.detectionCount}`, 20, 30);
                    ctx.fillText(`Timestamp: ${new Date().toISOString()}`, 20, 55);
                }
                
                // Download the captured frame
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `edge_ai_frame_${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
                
                // Visual feedback
                const button = document.getElementById('captureFrame');
                const originalText = button.textContent;
                button.textContent = '‚úÖ Captured!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }

            saveModel() {
                // Simulate model saving (in real implementation, save trained CV model)
                const button = document.getElementById('saveModel');
                button.textContent = 'üíæ Saving...';
                button.disabled = true;
                
                setTimeout(() => {
                    // Create a mock model file for download
                    const modelData = {
                        modelType: 'edge_ai_cv_model',
                        timestamp: new Date().toISOString(),
                        detectionCount: this.detectionCount,
                        trainingFrames: Math.floor(Math.random() * 1000 + 500),
                        accuracy: (Math.random() * 0.2 + 0.8).toFixed(3),
                        modelSize: Math.floor(Math.random() * 50 + 10) + 'MB'
                    };
                    
                    const blob = new Blob([JSON.stringify(modelData, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `edge_ai_model_${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    button.textContent = '‚úÖ Model Saved!';
                    setTimeout(() => {
                        button.textContent = 'üíæ Save Model';
                        button.disabled = false;
                    }, 2000);
                }, 1500);
            }

            stopStreaming() {
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                }
                
                document.getElementById('remoteVideo').srcObject = null;
                document.getElementById('videoOverlay').style.display = 'block';
                
                // Disable controls
                document.getElementById('startDetection').disabled = true;
                document.getElementById('captureFrame').disabled = true;
                document.getElementById('saveModel').disabled = true;
                document.getElementById('stopStreaming').disabled = true;
                
                // Stop detection if active
                if (this.detectionActive) {
                    this.toggleDetection();
                }
                
                this.connectedDevices = 0;
                this.updateStatus('waiting', 'üì± Stream stopped. Waiting for reconnection...');
            }

            updateVideoStats() {
                if (this.currentStream) {
                    const videoTrack = this.currentStream.getVideoTracks()[0];
                    if (videoTrack) {
                        const settings = videoTrack.getSettings();
                        document.getElementById('videoResolution').textContent = 
                            `${settings.width || 1280}x${settings.height || 720}`;
                        document.getElementById('frameRate').textContent = 
                            `${settings.frameRate || 30} FPS`;
                        document.getElementById('streamQuality').textContent = 'HD';
                    }
                }
                
                // Simulate network latency
                document.getElementById('streamLatency').textContent = 
                    `${Math.floor(Math.random() * 30 + 20)} ms`;
            }

            updateStatus(type, message) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `status ${type}`;
                statusElement.textContent = message;
                
                if (type === 'connected') {
                    statusElement.classList.add('pulse');
                } else {
                    statusElement.classList.remove('pulse');
                }
            }

            testConnection() {
                const button = document.getElementById('testConnection');
                button.textContent = 'üîó Testing...';
                button.disabled = true;
                
                setTimeout(() => {
                    const success = Math.random() > 0.3; // 70% success rate
                    if (success) {
                        alert('‚úÖ Connection test successful!\nLatency: 25ms\nBandwidth: 50 Mbps');
                    } else {
                        alert('‚ö†Ô∏è Connection test failed!\nCheck WiFi connection and firewall settings.');
                    }
                    
                    button.textContent = 'üîó Test Connection';
                    button.disabled = false;
                }, 2000);
            }

            // Phone-specific methods
            async switchCamera() {
                if (!this.currentStream) return;
                
                const videoTrack = this.currentStream.getVideoTracks()[0];
                const currentFacingMode = videoTrack.getSettings().facingMode;
                const newFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                
                try {
                    // Stop current stream
                    this.currentStream.getTracks().forEach(track => track.stop());
                    
                    // Start new stream with opposite camera
                    this.currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: newFacingMode,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: true
                    });
                    
                    document.getElementById('phoneVideo').srcObject = this.currentStream;
                    document.getElementById('phoneStatus').textContent = 
                        `Using ${newFacingMode === 'environment' ? 'back' : 'front'} camera`;
                        
                } catch (error) {
                    console.error('Camera switch failed:', error);
                    document.getElementById('phoneStatus').textContent = 'Camera switch failed';
                }
            }

            toggleFlash() {
                if (!this.currentStream) return;
                
                const videoTrack = this.currentStream.getVideoTracks()[0];
                if (videoTrack && 'torch' in videoTrack.getCapabilities()) {
                    const currentTorch = videoTrack.getSettings().torch;
                    videoTrack.applyConstraints({
                        advanced: [{torch: !currentTorch}]
                    }).then(() => {
                        document.getElementById('phoneStatus').textContent = 
                            `Flash ${!currentTorch ? 'ON' : 'OFF'}`;
                    }).catch(error => {
                        console.error('Flash toggle failed:', error);
                    });
                } else {
                    document.getElementById('phoneStatus').textContent = 'Flash not supported';
                }
            }

            startPhoneStreaming() {
                const button = document.getElementById('startPhoneStream');
                if (button.textContent.includes('üìπ')) {
                    // Start streaming to desktop
                    button.textContent = '‚èπÔ∏è';
                    document.getElementById('phoneStatus').textContent = 'Streaming to desktop...';
                    
                    // In real implementation, establish WebRTC connection to desktop
                    this.simulatePhoneToDesktopStream();
                    
                } else {
                    // Stop streaming
                    button.textContent = 'üìπ';
                    document.getElementById('phoneStatus').textContent = 'Stream stopped';
                }
            }

            simulatePhoneToDesktopStream() {
                // Simulate sending stream data to desktop
                let dataCount = 0;
                const streamInterval = setInterval(() => {
                    dataCount += Math.random() * 0.5;
                    
                    // Update desktop stats (if we could communicate)
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'phoneStreamData',
                            data: dataCount
                        }, '*');
                    }
                }, 1000);
                
                // Store interval for cleanup
                this.phoneStreamInterval = streamInterval;
            }

            disconnectPhone() {
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                }
                
                if (this.phoneStreamInterval) {
                    clearInterval(this.phoneStreamInterval);
                }
                
                document.getElementById('phoneVideo').srcObject = null;
                document.getElementById('phoneStatus').textContent = 'Disconnected';
                
                // Redirect back to QR page or show disconnect message
                setTimeout(() => {
                    window.location.href = window.location.href.replace('?phone=1', '');
                }, 2000);
            }

            startStatsUpdater() {
                setInterval(() => {
                    if (this.serverRunning) {
                        // Update server uptime
                        if (this.startTime) {
                            const elapsed = Date.now() - this.startTime;
                            const seconds = Math.floor(elapsed / 1000);
                            const minutes = Math.floor(seconds / 60);
                            const hours = Math.floor(minutes / 60);
                            
                            let uptimeStr = '';
                            if (hours > 0) uptimeStr += `${hours}h `;
                            if (minutes > 0) uptimeStr += `${minutes % 60}m `;
                            uptimeStr += `${seconds % 60}s`;
                            
                            document.getElementById('serverUptime').textContent = uptimeStr;
                        }
                        
                        // Update data transfer
                        const currentData = parseFloat(document.getElementById('dataTransfer').textContent) || 0;
                        const newData = currentData + Math.random() * 0.1;
                        document.getElementById('dataTransfer').textContent = `${newData.toFixed(1)} MB`;
                        
                        // Update connected devices
                        document.getElementById('connectedDevices').textContent = this.connectedDevices;
                    }
                }, 1000);
            }
        }

        // Handle messages from phone iframe/window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'phoneStreamData') {
                // Update desktop stats with phone data
                console.log('Received phone stream data:', event.data.data);
            }
        });

        // Initialize the application when page loads
        window.addEventListener('load', () => {
            new OfflineEdgeAI();
        });
    </script>
</body>
</html>